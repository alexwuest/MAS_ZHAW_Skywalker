{% include "header.html" %}

<tr class="middle-row">
  <td colspan="2" style="background-color: #e0f7fa; padding: 16px; font-size: 13px;">
    {% if device %}
      <h2>Grouped Overview for: {{ device.device_id }} - {{ device.description }}</h2>

      <form method="get" style="margin-bottom: 20px;">
        <input type="hidden" name="device_id" value="{{ selected_device_id }}">
        
        <select name="filter_recent" id="filter_recent">
          <option value="60" {% if selected_filter == '60' or not selected_filter %}selected{% endif %}>Last 60 seconds</option>
          <option value="120" {% if selected_filter == '120' %}selected{% endif %}>Last 120 seconds</option>
          <option value="180" {% if selected_filter == '180' %}selected{% endif %}>Last 180 seconds</option>
          <option value="240" {% if selected_filter == '240' %}selected{% endif %}>Last 240 seconds</option>
          <option value="360" {% if selected_filter == '360' %}selected{% endif %}>Last 360 seconds</option>
        </select>
        <button type="submit">Refresh</button>
        <label for="filter_recent"> Show only entries from last:</label>
      </form>
      
      <form method="post" action="{% url 'flush-metadata' %}" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="device_id" value="{{ selected_device_id }}">
        <button type="submit">Flush Seen Metadata</button> Mark all seen IPs as not seen anymore
      </form>
      <br><br>
      NOTE: Manual added IP's will not be managed with the ISP Rules. So make sure to check "Firewall rules" if all rules should be removed!

      <h3 style="margin-top: 24px;">New IPs</h3>
      {% if new_ips %}
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
          <colgroup>
            <col style="width: 40px;">
            <col style="width: 150px;">
            <col style="width: 230px;">
            <col style="width: 230px;">
            <col style="width: 350px;">
            <col style="width: 300px;">
            <col style="width: 220px;">
            <col style="width: auto;">
          </colgroup>
          <thead>
            <tr style="background-color: #cceeff;">
              <th style="text-align: left; padding: 6px;">Rule</th>
              <th style="text-align: left; padding: 6px;">IP</th>
              <th style="text-align: left; padding: 6px;">ORG</th>
              <th style="text-align: left; padding: 6px;">ISP</th>
              <th style="text-align: left; padding: 6px;">Location</th>
              <th style="text-align: left; padding: 6px;">AS Number</th>
              <th style="text-align: left; padding: 6px;">AS Name</th>
              <th style="text-align: left; padding: 6px;">DNS</th>
            </tr>
          </thead>
          <tbody>
            {% for ip, meta in new_ips %}
            <tr>
              <td style="padding: 6px;">
                {% with source_ip=device.leases.first.ip_address destination_ip=ip %}
                  {% with key=source_ip|add:"|"|add:destination_ip %}
                    {% if key in active_rules_dict %}
                      <form method="POST" action="{% url 'remove-rule-view' %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="source_ip" value="{{ source_ip }}">
                        <input type="hidden" name="destination_ip" value="{{ destination_ip }}">
                        <button type="submit">−</button>
                      </form>
                    {% else %}
                      <form method="POST" action="{% url 'add-rule-view' %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="source_ip" value="{{ source_ip }}">
                        <input type="hidden" name="destination_ip" value="{{ destination_ip }}">
                        <button type="submit">+</button>
                      </form>
                    {% endif %}
                  {% endwith %}
                {% endwith %}
              </td>
              <td style="padding: 6px;">{{ ip }}</td>
              <td style="padding: 6px;">{{ meta.org }}</td>
              <td style="padding: 6px;">{{ meta.isp }}</td>
              <td style="padding: 6px;">{{ meta.zip_code }} {{ meta.city }}, {{ meta.country }}</td>
              <td style="padding: 6px;">{{ meta.as_number }}</td>
              <td style="padding: 6px;">{{ meta.as_name }}</td>
              <td style="padding: 6px;">{{ meta.dns_name }}</td>
            </tr>
            {% endfor %}
          </tbody>
          
        </table>
      {% else %}
        <p><em>No new IPs.</em></p>
      {% endif %}

      <hr>

      <h3 style="margin-top: 24px;">Overview by ISP</h3>
      {% for isp, entries in overview.items %}
        <details open style="margin-bottom: 10px;">
          <summary style="font-weight: bold; cursor: pointer;">{{ isp }} ({{ entries|length }})</summary>
          <table style="width: 100%; border-collapse: collapse; margin-top: 6px; table-layout: fixed;">
            <colgroup>
              <col style="width: 40px;">
              <col style="width: 150px;">
              <col style="width: 230px;">
              <col style="width: 230px;">
              <col style="width: 350px;">
              <col style="width: 300px;">
              <col style="width: 220px;">
              <col style="width: auto;">
            </colgroup>
            <thead>
              <tr style="background-color: #ffdca8;">
                <th style="text-align: left; padding: 6px;">Rule</th>
                <th style="text-align: left; padding: 6px;">IP</th>
                <th style="text-align: left; padding: 6px;">ORG</th>
                <th style="text-align: left; padding: 6px;">ISP</th>
                <th style="text-align: left; padding: 6px;">Location</th>
                <th style="text-align: left; padding: 6px;">AS Number</th>
                <th style="text-align: left; padding: 6px;">AS Name</th>
                <th style="text-align: left; padding: 6px;">DNS</th>
              </tr>
            </thead>
            <tbody>
              {% for ip, meta in entries %}
              <tr>
                <td style="padding: 6px;">
                  {% with source_ip=device.leases.first.ip_address destination_ip=ip %}
                    {% with key=source_ip|add:"|"|add:destination_ip %}
                      {% if key in active_rules_dict %}
                        <form method="POST" action="{% url 'remove-rule-view' %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="source_ip" value="{{ source_ip }}">
                          <input type="hidden" name="destination_ip" value="{{ destination_ip }}">
                          <button type="submit">−</button>
                        </form>
                      {% else %}
                        <form method="POST" action="{% url 'add-rule-view' %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="source_ip" value="{{ source_ip }}">
                          <input type="hidden" name="destination_ip" value="{{ destination_ip }}">
                          <button type="submit">+</button>
                        </form>
                      {% endif %}
                    {% endwith %}
                  {% endwith %}
                </td>
                <td style="padding: 6px;">{{ ip }}</td>
                <td style="padding: 6px;">{{ meta.org }}</td>
                <td style="padding: 6px;">{{ meta.isp }}</td>
                <td style="padding: 6px;">{{ meta.zip_code }} {{ meta.city }}, {{ meta.country }}</td>
                <td style="padding: 6px;">{{ meta.as_number }}</td>
                <td style="padding: 6px;">{{ meta.as_name }}</td>
                <td style="padding: 6px;">{{ meta.dns_name }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>
      {% endfor %}
    {% else %}
      <p>Please select a device to see its IP overview.</p>
    {% endif %}
  </td>
</tr>

{% include "footer.html" %}
