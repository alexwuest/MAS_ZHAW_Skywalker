{% include "header.html" %}        
        <tr class="middle-row">
            <td style="width: 80%; background-color: #e0f7fa;">
                <h2>Blocked Connections</h2>
                <pre class="log_output">
{{ logs|safe }}
                </pre>
            </td>
            <td style="width: 20%; background-color: #ffe0b2;">
                <label for="refreshRate"><strong>Refresh page:</strong></label><br/>
                <select id="refreshRate" onchange="setRefreshRate()">
                    <option value="0">Off</option>
                    <option value="5000">Every 5s</option>
                    <option value="10000">Every 10s</option>
                    <option value="30000">Every 30s</option>
                </select>
                
                <button onclick="location.reload();">Refresh Now</button>

                <h3>Organisations (ISP)</h3>
                <div id="ispList" style="font-family: monospace; font-size: 12px;">
                    {% for isp in isp_list %}
                    <label style="display: block; margin-bottom: 4px;">
                        <input type="checkbox"
                            data-isp-name="{{ isp.name }}"
                            onchange="toggleISPLink(this)">
                        {{ isp.name }}
                    </label>
                    {% empty %}
                    <p><em>No ISPs found.</em></p>
                    {% endfor %}
                </div>
                <button id="updateButton" onclick="updateFirewallRules()">Update Firewall Rules</button>
                <h3>IP Info</h3><pre class="log_output">{% for ip, data in ip_data.items %}
üåê {{ ip }} | {{ data.dns_name|default:"N/A" }} | {{ data.isp|default:"N/A" }}
{{ data.city|default:"N/A" }}, {{ data.country|default:"N/A" }}
{% endfor %}
                </pre>
            </td>
        </tr>

<script>
    function getCookie(name) {
        const cookie = document.cookie.split(';').find(c => c.trim().startsWith(name + '='));
        return cookie ? decodeURIComponent(cookie.trim().split('=')[1]) : null;
    }

    function loadDeviceISPLinks() {
        const params = new URLSearchParams(window.location.search);
        const deviceId = params.get("device") || document.getElementById('deviceSelect').value;

        if (deviceId) {
            document.getElementById('deviceSelect').value = deviceId;
        }

        fetch(`/api/device/${deviceId}/linked-isps/`)
            .then(response => response.json())
            .then(data => {
                const linkedIsps = data.linked_isps;
                document.querySelectorAll('#ispList input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = linkedIsps.includes(checkbox.dataset.ispName);
                });
            });
    }

    function toggleISPLink(checkbox) {
        const deviceId = document.getElementById('deviceSelect').value;
        const ispName = checkbox.dataset.ispName;
        const link = checkbox.checked;

        fetch('/api/toggle-isp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: `device_id=${deviceId}&isp_name=${encodeURIComponent(ispName)}&link=${link}`
        });
    }

    function onDeviceSelectChange(select) {
        const deviceId = select.value;
        const params = new URLSearchParams(window.location.search);
        params.set("device", deviceId);
        window.location.search = params.toString();
    }

    function setRefreshRate() {
        const rate = parseInt(document.getElementById('refreshRate').value);
        localStorage.setItem("refreshRate", rate);
        if (refreshTimeout) clearTimeout(refreshTimeout);
        if (rate > 0) {
            refreshTimeout = setTimeout(() => {
                window.location.reload();
            }, rate);
        }
    }

    let refreshTimeout = null;

    window.onload = function () {
        const savedRate = localStorage.getItem("refreshRate") || "5000";
        const refreshSelect = document.getElementById('refreshRate');
        if (refreshSelect) {
            refreshSelect.value = savedRate;
        }
        if (parseInt(savedRate) > 0) {
            setRefreshRate();
        }
        loadDeviceISPLinks();

    }

       
    let lastRefreshRate = null;

    function updateFirewallRules() {
        const deviceId = document.getElementById('deviceSelect').value;
        const button = document.getElementById('updateButton');

        // Disable button and show loading text
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "Updating... can take a while!!!";

        // Save current refresh rate and stop auto-refresh
        const refreshSelect = document.getElementById('refreshRate');
        lastRefreshRate = refreshSelect.value;
        refreshSelect.value = "0";
        if (refreshTimeout) clearTimeout(refreshTimeout);

        fetch("/update-firewall/", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `device_id=${encodeURIComponent(deviceId)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                const added = data.rules_added ?? 0;
                const removed = data.rules_removed ?? 0;

                alert(`+ Rules added: ${added}\n- Rules removed: ${removed}`);
            } else {
                alert(`Error: ${data.message}`);
            }
        })

        .catch(error => {
            console.error("Update error:", error);
            alert("Something went wrong.");
        })
        .finally(() => {
            // Re-enable button
            button.disabled = false;
            button.textContent = originalText;

            // Restore refresh rate
            refreshSelect.value = lastRefreshRate;
            setRefreshRate();
        });
    }


</script>
{% include "footer.html" %}