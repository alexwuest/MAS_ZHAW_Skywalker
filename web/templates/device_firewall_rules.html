{% include "header.html" %}

<tr class="middle-row">
  <td colspan="2" style="background-color: #e0f7fa; padding: 16px; font-family: monospace; font-size: 13px;">
    {% if device %}
      <h2>Firewall Rules for {{ device.device_id }}</h2>

      {% if rules %}
      <table style="border: 1px solid black; border-collapse: collapse; font-family: monospace; font-size: 13px;">
        <thead>
          <tr>
            <th style="border: 1px solid black;">Action</th>
            <th style="border: 1px solid black;">Protocol</th>
            <th style="border: 1px solid black;">Source IP</th>
            <th style="border: 1px solid black;">Destination</th>
            <th style="border: 1px solid black;">Port</th>
            <th style="border: 1px solid black;">ISP</th>
            <th style="border: 1px solid black;">Since</th>
            <th style="border: 1px solid black;">Delte</th>
          </tr>
        </thead>
        <tbody>
          {% for rule in rules %}
            <tr>
              <td style="border: 1px solid black;">{{ rule.action }}</td>
              <td style="border: 1px solid black;">{{ rule.protocol }}</td>
              <td style="border: 1px solid black;">{{ rule.source_ip }}</td>
              <td style="border: 1px solid black;">
                {{ rule.destination_ip }}
                {% if rule.destination_info %}
                  <br><small>{{ rule.destination_info.city }}, {{ rule.destination_info.country }}</small>
                {% endif %}
              </td>
              <td style="border: 1px solid black;">{{ rule.port }}</td>
              <td style="border: 1px solid black;">{{ rule.isp_name }}</td>
              <td style="border: 1px solid black;">{{ rule.start_date|date:"Y-m-d H:i" }}</td>
              <td style="border: 1px solid black;"><button onclick="removeRule({{ rule.id }})">Remove</button></td>

            </tr>
          {% endfor %}
        </tbody>
      </table>
      
      {% else %}
        <p>No active firewall rules for this device.</p>
      {% endif %}
    {% endif %}
    </td>
  </tr>
  <script>
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function removeRule(ruleId) {
        if (!confirm("Are you sure you want to remove this rule?")) return;
    
        fetch("{% url 'remove-firewall-rule' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: `rule_id=${ruleId}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                location.reload();
            } else {
                alert("Error removing rule: " + data.message);
            }
        })
        .catch(err => {
            console.error("Error:", err);
            alert("Something went wrong.");
        });
    }
    </script>
    
{% include "footer.html" %}