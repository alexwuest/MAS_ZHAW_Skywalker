{% include "header.html" %}

<div class="content" style="display: flex; height: 100%; min-height: 500px;">
    
    <!-- Log section / LEFT -->
    <div style="flex: 4; background-color: #f9f9f9; font-size: 13px; padding: 16px; overflow-y: auto;">
        <h2>PASSED Connections (Recent 2000 entries)</h2>
        <pre class="log_output">
{{ logs|safe }}
        </pre>
    </div>

    <!-- Log section / RIGHT -->
    <div style="flex: 1; background-color: #f9f9f9; padding: 16px; font-size: 13px; overflow-y: auto;">
        <label for="refreshRate"><strong>Refresh page:</strong></label><br/>
        <select id="refreshRate" onchange="setRefreshRate()">
            <option value="0">Off</option>
            <option value="5000">Every 5s</option>
            <option value="10000">Every 10s</option>
            <option value="30000">Every 30s</option>
        </select>
        <button onclick="location.reload();">Refresh Now</button>
        <h3 style="margin-top: 24px;">Organisations (ISP)</h3>
        <div id="ispList" font-size: 12px;">
            {% for isp in isp_list %}
            <label style="display: block; margin-bottom: 4px;">
                <input type="checkbox"
                    data-isp-name="{{ isp.name }}"
                    onchange="toggleISPLink(this)">
                {{ isp.name }}
            </label>
            {% empty %}
            <p><em>No ISPs found.</em></p>
            {% endfor %}
        </div></br></br>
        This button will update device rules. Adding new ones and removing outdated ones:</br></br>
        <button id="updateButton" onclick="updateFirewallRules()">Update Firewall Rules</button>
    </div>
</div>

<script>
    function getCookie(name) {
        const cookie = document.cookie.split(';').find(c => c.trim().startsWith(name + '='));
        return cookie ? decodeURIComponent(cookie.trim().split('=')[1]) : null;
    }

    function loadDeviceISPLinks() {
        const params = new URLSearchParams(window.location.search);
        const deviceId = params.get("device") || document.getElementById('deviceSelect').value;

        if (deviceId) {
            document.getElementById('deviceSelect').value = deviceId;
        }

        fetch(`/api/device/${deviceId}/linked-isps/`)
            .then(response => response.json())
            .then(data => {
                const linkedIsps = data.linked_isps;
                document.querySelectorAll('#ispList input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = linkedIsps.includes(checkbox.dataset.ispName);
                });
            });
    }

    function toggleISPLink(checkbox) {
        const deviceId = document.getElementById('deviceSelect').value;
        const ispName = checkbox.dataset.ispName;
        const link = checkbox.checked;

        fetch('/api/toggle-isp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: `device_id=${deviceId}&isp_name=${encodeURIComponent(ispName)}&link=${link}`
        });
    }

    function setRefreshRate() {
        const rate = parseInt(document.getElementById('refreshRate').value);
        localStorage.setItem("refreshRate", rate);
        if (refreshTimeout) clearTimeout(refreshTimeout);
        if (rate > 0) {
            refreshTimeout = setTimeout(() => {
                window.location.reload();
            }, rate);
        }
    }

    let refreshTimeout = null;

    window.onload = function () {
        const savedRate = localStorage.getItem("refreshRate") || "5000";
        const refreshSelect = document.getElementById('refreshRate');
        if (refreshSelect) {
            refreshSelect.value = savedRate;
        }
        if (parseInt(savedRate) > 0) {
            setRefreshRate();
        }
        loadDeviceISPLinks();

    }

    let lastRefreshRate = null;
    function updateFirewallRules() {
        const deviceId = document.getElementById('deviceSelect').value;
        const button = document.getElementById('updateButton');
        const overlay = document.getElementById('overlay');

        // Disable button and show loading text
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "Updating... can take a while!!!";

        // Show overlay to block UI
        overlay.style.display = "block";

        // Save current refresh rate and stop auto-refresh
        const refreshSelect = document.getElementById('refreshRate');
        lastRefreshRate = refreshSelect.value;
        refreshSelect.value = "0";
        if (refreshTimeout) clearTimeout(refreshTimeout);

        fetch("/update-firewall/", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `device_id=${encodeURIComponent(deviceId)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                const added = data.rules_added ?? 0;
                const removed = data.rules_removed ?? 0;

                alert(`+ Rules added: ${added}\n- Rules removed: ${removed}`);
            } else {
                alert(`Error: ${data.message}`);
            }
        })

        .catch(error => {
            console.error("Update error:", error);
            alert("Something went wrong.");
        })
        .finally(() => {
            // Re-enable button
            button.disabled = false;
            button.textContent = originalText;
            overlay.style.display = "none";

            // Restore refresh rate
            refreshSelect.value = lastRefreshRate;
            setRefreshRate();
        });
    }

</script>
{% include "footer.html" %}