############################################################################################################
## Here i will write down my history. The steps for an easier understanding of the process.
############################################################################################################

################################
## Starting February 2025
################################
# Searched for a setting how to achieve the goal to route all traffic from mobiles trough a Firewall where all traffic will natively be dropped. 
# The idea is to not develop the firewall logic / software by myself so i looked for reliable software firewall solutions. I finally compared OPNsense and pfSense.
# I found that OPNSense is more user friendly and has a better UI. I decided to go with OPNSense.
# The idea is to route all traffic trough a hardware where the OPNSense Firewall is installed. Before there will be a WLAN Access Point

################################
## Buying the hardware Firewall
################################
# With Protectli i found a company located in Europe which offers hardware firewalls with ONSense installed. Ordered 09.02.2025 // 284.55â‚¬
# V1410 - 8GB RAM, 250GB SSD, 4x Intel NICs, 2x USB 3.0, 1x HDMI, 1x COM, 1x VGA, 1x Power Supply

################################
## Buying the Access Point
################################
# TP-Link Omada EAP610GP-DESKTOP WLAN Access Point 1201. Ordered 12.02.2025 // 93.90 CHF

################################
## 15.02.2025
################################
# Checked the actual Python version on the notebook no update needed :-)
wunderli@MacBook-Air-von-Alex ~ % python3 --version
Python 3.13.1
# Setup the GitHub (mas) Private Repository for the project
# Created this mas_workbook.md file and made the first entries

# Worked trough the django documentation to get a better understanding of the framework
# Installed Django 5.1.6
python3 -m pip install Django==5.1.6

# Verfied does the actual Django version is accessible from python
wunderli@MacBook-Air-von-Alex ~ % python3 
Python 3.13.1 (v3.13.1:06714517797, Dec  3 2024, 14:00:22) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import django
>>> print(django.get_version())
5.1.6

# As all documentation always use "pyton" as command but my mac only accepts "python3" as command
# I created an Symlink for python
sudo ln -s /Library/Frameworks/Python.framework/Versions/3.13/bin/python3 /usr/local/bin/python

# But i thought that is not the right approach as this is a static way and it probably needs to be updated regularly so i found the possibly of a Dynamic Symlink.
sudo ln -sf /Library/Frameworks/Python.framework/Versions/Current/bin/python3 /usr/local/bin/python

# I started with the first Django project
# Django has an built in webserver for development purposes it can be started with the following command
python manage.py runserver

# Now i'm ready to work with Django, Python
# Some notices to handle django db's

#Change your models (in models.py).
python manage.py makemigrations #to create migrations for those changes
python manage.py migrate #to apply those changes to the database.

################################
## 25.02.2025 - 12.02.2025
################################
# Went on holiday and spent a bunch of time programming on another project for Stadtpolizei Zurich.
# I learned a lot and i'm ready to continue with the python firewall project.

################################
## 14.03.2025
################################
# I moved the setting to my cellar and started to install the hardware firewall and the access point.
# I had troubles with the setup last time as i'm in my office behind some hardware i don't want to change the settings.
# Now the Firewall is up and running and i'm able to access the web interface. It is directly connected to my Router
# In the OPNSense Firewall i just plugged in a WLAN Router and configured it as an Access Point.

# Configuration of the Firewall
# All traffic within the LAN_net to the Firewall is allowed to always be able to access the webgui. This is the main rule.
# The last rule i added is a block all traffic rule. So no traffic within the network and also no traffic out of the network is allowed. Also no inbound traffic is allowed.
# The aim for today is to get access to the API and be able to configure firewall settings via the API and if possible to get the logs especially the blocked traffic.
# I was able to get the firewall rules which were before made by the api... not the other rules but i think that will be ok as all rules will be made by the API.
# I was not able to retrieve the logs via the API. It seems that is not supported yet. I tried to get the logs by ssh so i can parse them and use them in the program. 

ssh root@192.168.5.1
/var/log/filter/latest.log

# One entry looks like this
<134>1 2025-03-14T16:16:55+00:00 OPNsense.localdomain filterlog 36886 - [meta sequenceId="2631"] 69,,,1eb94a38e58994641aff378c21d5984f,igc1,match,block,in,4,0x0,,64,32149,0,DF,17,udp,32,192.168.1.14,255.255.255.255,3000,2000,12

ChatGPT:
A UDP packet was blocked by the firewall.
The packet came from 192.168.1.14 (inside the LAN).
The destination was 255.255.255.255 (a broadcast message).
The source port was 3000, and the destination port was 2000.
The firewall blocked this packet on the igc1 interface (likely LAN).
The rule that blocked it has ID 69.

# The next idea is now to get all connected devices to the firewall. Get IP and MAC address and make a list of all devices.
# After i want to give fixed ip addresses to the devices to keep them always on the same ip address. And keep management easier. As all logfiles will not have any mac address entries. Probably it make sense to have a bigger address area like 255.255.0.0/16. I expect not more than 100 devices in the network during one year and the inspection period is probably just a few weeks so after the case is closed the ip address could be released again.

################################
## 15.03.2025
################################

# Connected today my iphone to the wlan network the first time. I knew that the iphone has by default the option to change the mac address regularly. But it connected also twice to the network with different ip addresses and different mac addresses at the same time. Ok i was wrong... that was my apple watch which just a few seconds after joined the wlan as well. I deleted the leases on the firewall and the iphone yet did not change the mac address. Actually it is 02:89:49:2b:5c:f2. However as we block all devices on unknown devices that will not be a problem. If the mac address changes we need to add a new mac address. My idea is now to have the Asservate Nr. as centralized ID. To add a list with mac addresses to it to identify the devices. However i need to make sure no other device has the same mac address and need to make sure that the mac address is also in relation to the time when it was active. So if there is another mac address which is the same i hope it will not be in the same time frame.

#Some API Feedbacks

{"total":4,"rowCount":4,"current":1,"rows":
 
 [{"address":"192.168.5.101","starts":"2025\/03\/15 07:11:57","ends":"2025\/03\/16 07:11:57","tstp":1742109117,"cltt":1742022717,"binding":"active","uid":"\\001\\330D\\211wVH","client-hostname":"EAP610GP-Desktop-D8-44-89-77-56-48","type":"dynamic","status":"online","descr":"","mac":"d8:44:89:77:56:48","hostname":"EAP610GP-Desktop-D8-44-89-77-56-48","state":"active","man":"TP-LINK CORPORATION PTE. LTD.","if":"lan","if_descr":"LAN"},
  
  {"address":"192.168.5.103","starts":"2025\/03\/15 07:21:59","ends":"2025\/04\/14 07:21:59","tstp":1744615319,"cltt":1742023319,"binding":"active","uid":"\\001\\262\\254\\034a\\216\\021","type":"dynamic","status":"online","descr":"","mac":"b2:ac:1c:61:8e:11","hostname":"","state":"active","man":"","if":"lan","if_descr":"LAN"},
  
  {"address":"192.168.5.155","starts":"2025\/03\/15 07:22:06","ends":"2025\/04\/14 07:22:06","tstp":1744615326,"cltt":1742023326,"binding":"active","uid":"\\001P\\246\\330\\256f\\220","client-hostname":"Air-von-Alex","type":"dynamic","status":"online","descr":"","mac":"50:a6:d8:ae:66:90","hostname":"Air-von-Alex","state":"active","man":"Apple, Inc.","if":"lan","if_descr":"LAN"},
  
  {"address":"192.168.5.156","starts":"2025\/03\/15 07:07:58","ends":"2025\/04\/14 07:07:58","tstp":1744614478,"cltt":1742022478,"binding":"active","uid":"\\001\\002\\211I+\\\\\\362","type":"dynamic","status":"online","descr":"","mac":"02:89:49:2b:5c:f2","hostname":"","state":"active","man":"","if":"lan","if_descr":"LAN"}],"interfaces":{"lan":"LAN"}}

# Feedback for a specific block...

{"rulenr":"81","subrulenr":"","anchorname":"","rid":"b9f1d749b2037601dc5e6d1798e9faf2","interface":"igc0","reason":"match","action":"block","dir":"in","ipversion":"4","tos":"0x0","ecn":"","ttl":"64","id":"0","offset":"0","ipflags":"DF","protonum":"6","protoname":"tcp","length":"64","src":"192.168.5.156","dst":"17.248.209.68","srcport":"61102","dstport":"443","datalen":"0","tcpflags":"S","seq":"2973452762","ack":"","urp":"0","tcpopts":"","__timestamp__":"2025-03-15T14:41:18","__host__":"OPNsense.localdomain","__digest__":"8b127b564bf8acdfa90234321b703846","__spec__":["rulenr","subrulenr","anchorname","rid","interface","reason","action","dir","ipversion","tos","ecn","ttl","id","offset","ipflags","protonum","protoname","length","src","dst","srcport","dstport","datalen","tcpflags","seq","ack","urp","tcpopts"],"label":"BLOCK all LAN communication and internet traffic"},

# Some IP addresses when opening the heise app on my mobilephone
New Unique IPs: {'116.203.25.165', '159.69.45.25', '91.215.100.40', '185.54.150.27', '193.99.144.85', '159.69.145.0', '78.46.198.121'}

# Had a great day. I wanted to now just accept traffic to a specific app. Web Apps seem to be a bit hard as i don't really want to accept Apple traffic. So i tried it with WhatsApp and Telegram. Not really a great success. I was able to get the IP addresses but the traffic is still blocked. I think i need to allow the traffic to the IP addresses. When i accept one ip the next is coming i have to allow and so one... For whatsapp after 8 ip addresses i gave up, the app is still not connected. I also added some CDN to the allow list.
# 
#157.240.17.61 -> whatsapp-chatd-edge-shv-01-zrh1.facebook.com
#157.240.0.61 -> whatsapp-chatd-edge-shv-02-fra3.facebook.com
#31.13.88.61 -> whatsapp-chatd-edge-shv-02-atl3.facebook.com
#157.240.11.54 -> whatsapp-chatd-edge-shv-02-lax3.facebook.com
#15.197.206.217 -> ac9293e5fb5d2d1d2.awsglobalaccelerator.com
#80.67.82.201 -> a80-67-82-201.deploy.static.akamaitechnologies.com
#173.222.108.248 -> a173-222-108-248.deploy.static.akamaitechnologies.com
#3.33.221.48 -> a66e5b8d30b652954.awsglobalaccelerator.com
#
# I need to look if i can make rules based on dns names...
#
#
#Remove all rules and connecting the mobile again with the wlan
#Already seen:
{'4.153.25.42', '52.97.201.242', '17.167.200.10', '49.12.196.20', '17.253.57.216', '172.224.55.13', '23.10.249.161', '17.188.143.126', '17.248.209.66', '17.253.57.206', '17.253.57.218', '17.248.209.64', '20.190.177.85', '17.253.57.199', '17.248.209.68', '17.248.209.67', '17.188.143.157', '172.224.55.7', '17.253.57.209', '20.190.147.7', '17.188.143.187', '17.188.143.189', '52.97.232.194', '40.99.201.210', '17.253.57.195', '17.253.57.202', '172.224.55.9', '194.56.36.112', '20.190.177.149', '17.188.179.2', '17.248.209.70', '17.253.57.196', '23.0.174.10', '172.224.55.3', '20.190.147.5', '172.224.55.12', '20.44.10.123', '172.224.55.5', '92.123.27.145', '17.57.172.5', '17.253.57.204', '17.248.209.69', '17.188.178.226', '2.21.22.154', '172.224.55.10', '17.248.209.65', '74.125.128.108', '20.190.147.10', '52.97.201.194', '172.224.55.6', '17.248.209.74', '20.190.177.21', '17.253.57.207', '23.0.174.16', '52.98.168.178', '40.99.201.194', '40.99.217.50', '20.190.147.2', '17.253.57.208', '52.97.232.210', '194.56.36.100', '17.188.178.2', '74.125.128.109', '20.190.177.84', '17.188.179.34', '2.21.22.160', '17.248.209.71', '17.253.57.200', '17.253.57.213', '172.224.55.8', '172.224.55.4', '23.0.174.9', '146.75.119.6', '20.42.73.27', '172.224.55.11', '17.253.57.214', '17.188.178.34', '17.188.143.125', '92.123.27.144', '17.248.209.72'}
# That are the ip addresses which are called just after joining the wlan...
#
# I see many entries like this:
# akamaitechnologies.com #CDN one of the biggest CDN providers
# aaplimg.com #Apple CDN
#
# Ok finaly i was not able to get any app online. I have now added all ip's which were blocked before and added a pass rule. I have now 158 ip's added with a regular iphone setting and i wanted just to open the swiss sbb app. So the iphone called 158 ips without any open app and with just opening the sbb app. I also added in the configuration as dns server 8.8.8.8 and also give the traffic to its destination free. I have also added a request for playing a sound when my iphone goes online by find my iphone... during the whole test my iphone was not ringging :p.
# As soon i add a firewall rule to allow all traffic from my phone to any it works... it also played the sound.
#
#
# Hours later... i tried to reboot the firewall and it worked. I could get access to the apps. Still quite restricted but it worked out! I need to figure out what the problem is as i'm already killing the states and it does not work as expected.
#
################################
## 16.03.2025
################################
# A point i have completly ignored yet is the Apple Private Relay. As i use a Apple iPhone i made some light research and found out does the Private Relay is deeper implementet in the system as i first tought. It is not just the Safari which is affected it is also regular web traffic made by apps if implemented. So i will make some tests today to see if this is the case for apps. If so I probably need to deactivate the Private Relay in the future to keep that traffic sorted. As in our use case we will have pysical access to the device and we will be able to deactivate Private Relay.
# Again i tested to get access after giving ip's for traffic free to sbb app or telegram. It worked after i restarted the firewall. Still not quite sure how i can cancel the connections so it needs to make a new connection with a pass firewall rule. I will make some tests today to see if i can find a solution for that.
#
################################
## 20.03.2025
################################
# I have now the option how to set the firewall rules and add it right away.
apply_url = f'{OPNSENSE_IP}/api/firewall/filter/apply'
# This API Endpoint gives the opportunity to add the filters right away.
# First tests looked good! Some times i just had to wait in the app sometimes i had to restart the app and it worked.
#
# I'm a bit unhappy not knowing that much about the ip's the mobile tries to connect. The reverse dns is not that informative...
# I found a solution with ip-api to find out much more about a ip than just the dns. Free option limited to 45 calls per minute and not commercial, if needed in the production enviroment i need to check if there is another solution or to apply for a plan.
#
# Today i want to make two test runs:
# -> Close all apps on my iphone
# -> Bluetooth off
# -> WLAN off
# -> Reboot the device
# -> Add pass rule for 8.8.8.8
# -> Connect the device to the WLAN
# -> Wait 10 minutes and collect all requested ip addresses
#
# Once with activated Private Relay and once with deactivated Private Relay
# 
# RUN 1: Private Relay activated
17.253.57.203,18.165.183.113,17.188.23.79,52.97.186.146,17.248.209.138,23.0.174.16,17.138.176.4,17.248.209.129,17.248.209.135,17.188.143.125,17.248.209.74,142.250.153.109,17.248.209.65,40.126.53.13,151.101.67.6,17.253.57.198,17.188.178.2,17.171.47.23,17.23.96.15,17.57.146.23,52.109.76.144,23.212.192.170,17.253.57.219,17.188.172.10,2.21.22.122,13.69.116.109,17.57.146.25,17.253.57.196,2.21.22.113,44.196.134.156,17.248.209.137,17.188.143.157,40.126.53.16,52.97.135.50,142.250.203.110,17.8.136.71,17.8.136.52,17.188.23.52,172.217.168.46,17.188.185.134,17.57.146.55,92.123.27.144,17.248.209.128,151.101.3.6,194.56.36.100,17.188.171.138,74.125.143.108,151.101.131.6,2.21.22.114,108.177.119.108,17.188.143.189,23.212.193.118,17.57.146.22,17.248.209.133,104.18.12.110,17.248.209.132,194.56.36.112,52.3.148.43,17.248.209.64,17.253.57.201,54.72.59.31,17.253.57.210,17.248.209.69,2.21.22.184,17.253.57.214,17.188.183.4,17.248.209.130,44.211.115.35,17.248.209.73,17.253.57.200,17.188.170.10,17.248.209.68,34.248.166.60,17.188.172.72,108.128.193.124,49.12.196.20,44.219.130.83,17.57.146.26,17.32.194.2,40.99.217.50,17.253.57.204,23.10.249.144,17.248.209.67,17.253.57.208,20.190.181.5,2.21.22.160,151.101.195.6,34.117.115.132,17.57.146.56,18.165.183.128,44.210.189.47,18.165.183.108,17.188.23.24,17.188.143.126,17.57.146.57,34.203.52.235,17.188.182.4,8.8.8.8,13.107.42.16,17.253.57.197,17.248.209.134,23.0.174.9,17.253.57.202,17.188.170.72,8.8.4.4,23.0.174.208,2.21.22.176,17.188.143.158,17.138.144.4,17.248.209.66,16.170.124.74,142.250.153.108,74.125.143.109,17.188.185.137,17.248.209.131,17.188.182.132,184.24.198.40,17.188.168.161,17.188.171.74,18.165.183.66,17.253.57.213,17.188.170.135,40.126.53.15,3.165.190.8,17.57.21.63,17.167.200.10,17.242.179.27,17.138.222.129,23.212.192.26,17.145.0.2,17.188.179.2,17.188.143.187,17.253.145.10,2.21.22.121,2.21.22.115,17.253.57.199,17.188.185.133,17.188.171.202,17.145.16.2,2.21.22.106,20.190.181.6,2.21.22.112,17.188.185.132,3.165.190.23,68.220.193.245,104.18.13.110,17.57.146.27,17.188.172.74,40.126.53.14,2.21.22.105,40.126.53.17,20.190.181.3,2.21.22.154,17.8.136.172,17.138.160.4,172.217.168.14,17.188.185.135,3.218.245.0,2.21.22.107,17.253.57.207,17.248.209.72,157.240.17.17,17.57.146.54,17.138.222.1,17.253.57.209,138.188.160.235,17.253.150.10,17.156.129.37,17.57.146.24,138.188.100.68,104.77.24.155,52.97.186.114,157.240.0.13,108.177.119.109,17.32.194.34,17.188.179.34,17.253.57.195,17.188.178.34,17.248.209.70,17.253.57.217,17.23.18.34,17.188.182.68,92.123.27.145,17.188.185.136,17.188.182.196,17.248.209.71
#
# RUN 2: Private Relay deactivated
17.188.143.158,17.188.185.133,23.212.193.118,17.188.185.134,23.212.192.26,2.21.22.107,17.253.57.207,172.224.55.8,17.57.146.57,104.18.12.110,52.98.163.18,23.0.174.208,17.188.172.72,52.97.135.50,17.253.57.210,17.253.57.209,17.111.103.20,172.224.55.13,17.137.162.3,2.21.22.106,17.32.194.34,17.188.170.10,17.188.143.187,108.128.193.124,17.188.182.68,2.21.22.104,40.99.217.50,17.57.146.23,104.18.13.110,172.217.168.46,17.248.209.135,20.189.173.5,17.253.57.197,17.248.209.73,17.188.179.34,17.57.146.25,172.224.55.6,17.138.222.129,17.188.179.2,173.194.69.109,172.217.218.109,17.253.57.208,17.253.57.202,17.188.143.189,172.217.218.108,17.188.171.74,17.253.57.199,17.57.21.63,17.57.146.55,17.248.209.70,17.145.0.2,17.248.209.64,17.188.185.136,17.253.57.200,52.97.186.114,194.56.36.112,17.36.206.4,17.57.146.54,108.177.119.108,17.57.146.22,17.253.145.10,49.12.196.20,17.248.209.68,17.188.178.226,17.188.183.4,17.188.172.10,2.21.22.113,17.188.182.196,2.21.22.170,2.21.22.184,172.224.55.5,138.188.100.68,17.188.172.74,17.157.96.170,40.99.201.178,17.188.185.137,17.253.57.198,172.224.55.7,17.32.194.22,17.253.57.218,8.8.4.4,17.248.209.137,17.253.57.195,108.177.119.109,17.188.143.157,2.21.22.105,138.188.160.235,142.250.203.110,17.57.146.56,17.248.209.69,173.194.69.108,17.36.206.5,17.253.57.215,17.138.222.1,17.248.209.131,2.21.22.115,52.109.76.144,17.57.146.26,17.57.146.27,17.32.194.2,17.248.209.136,17.188.185.132,17.188.143.126,151.101.195.6,17.253.57.203,17.179.252.2,17.188.168.161,151.101.3.6,2.21.22.122,172.224.55.10,17.188.171.202,17.242.184.19,17.188.178.2,17.167.200.10,2.21.22.121,17.248.209.74,17.188.170.135,23.0.174.9,2.21.22.112,194.56.36.100,17.253.57.214,2.21.22.123,17.253.57.213,52.98.250.130,17.138.144.4,40.99.201.194,151.101.67.6,17.248.209.67,151.101.131.6,17.248.209.71,172.224.55.3,17.188.182.132,17.253.57.196,4.152.45.207,17.253.57.201,17.248.209.128,17.57.146.24,17.188.185.135,23.10.249.144,172.224.55.11,23.0.174.16,52.98.246.50,172.224.55.4,34.117.115.132,17.188.178.34,17.248.209.66,172.224.55.12,52.97.201.226,17.253.57.204,17.248.209.138,17.188.182.4,17.188.171.138,52.98.168.178,172.224.55.9,17.248.209.72,17.248.209.65,2.21.22.114,92.123.27.145,17.188.170.72,17.188.143.125,17.253.150.10,184.24.198.40,92.123.27.144,52.97.186.146
#
# I had not yet the time to really compare these. But there are still many ips called from apple even with private relay deactivated.
################################
## 21.03.2025
################################
# I made some tests with find my device over icloud. The phone had bluetooth on. Same cloud account as my mac book which had full internet access. Bluetooth on both devices activated.
# The command seems to be queued. I expected does the iphone behave same as a airtag. So i can play a sound if needed. The location gets not updated, no sound if mobile is isolated. 
# I can open the traffic pretty much for everything just make sure to keep the "Apple Inc." closed. Today there were 41 ips in the 17.0.0.0/8 range. No ip outside. 
# Actually i would say the minimal product i want to implement is done. I can see to which ip's the mobile wants to connect. I can lookup the needed information for the ips and i group them by company.
# When opening a new application after some time i can clearly see to where the communication goes and i can easely open it for communication. So i have the opportunity to go into a specific app and lookup the needed stuff without any other connections.
# Could connect by VPN to Zurich City. Websites trough safari like 20min.ch or blick.ch can be quite a pain as many cdn ips need too be switched to pass. Not yet sure if that is really a problem.
#
# DJANGO Project
# I added first the models to have a clean data base structure to work with. After the first tests with the console i think i have already a great overview which fields will be needed.
# I created tree models 
# 
# FirewallLog           ->    Parsed logfiles stored into the database
# DestinationMetadata   ->    For each destination ip addresss some metadata stored once. Regularly check all used ips if already known and compare meta data. If changed add an end date to the old entry and make a new entry. This is especially important if an ip changed the owner.
# FirewallRule          ->    OPNSense Firewall rules if changed with history for logging purpose...
#
# Ok i always see the usecase -> i just add shortly a device and it's done... How if a device is for longer period attached and if we don't want to get that deep into the system. So a mac address could once switch by default not as know just deactivate with one click...
# So i need first to identify the device. All our devices have a forensic tracking number with barcode on it. So each device can be identified all time for sure. So this number needs to be the id number for each device connected to the forensic wlan / lan.
# This number wont change unless there is a new case for the same device. But then the logging would really needed to be separated. So all set.
# But as i have seen the mac address can change today. So i need to keep track. The IP address can switch also especially if there can not be a fixed ip address given as mac can swap. Of course later i will try to keep devices on the same ip but i will not be safe it that will definitely work.
# So i need another models
#
#
# Device                ->    Asservaten Nummer (device_id) and a description. Can easy be more detailed if for reporting the name, case number and others needed.
# DeviceMac             ->    Linked to the device_id with MAC address and its start / end timestamps
# DeviceIP              ->    Linked to the DeviceMac with the MAC address and a ip address and start / end timestamp for the ip address
#
# So i have now 6 models probably more will follow. I checked against the LLM and it seems to be a working way. Probably i need also to implement a kind of login method in the wlan.
# Like surfing with the device on a local page where i have to enter Asservaten Number and the page gets the actual ip and mac of the device and stores that into the db. New rules can just be added after that made. Of course there should be a manual way (device partially damaged). But with this also some examiner details could be grabed.
# After having the idea how it works again pushed it into LLM and got some great feedback about setting always timestamps auto when handling start time. Always use DateTime instead Date to have a precise timestamp.
# Not yet important but probably later, indexing the right fields for quicker searches. 
# Adding now the idea to link Firewall rules directly to the device. Of course it needs the ip address still but if this changes i would like to have the option to swap all rules which are related to A010101010 to the new associeted IP address so the work can go forward 

################################
## 25.03.2025
################################
# Started with some testing with the work yet.
# I have over 27k entries for ip addresses any many duplicates... i need to change the api_logs_parser.py to make sure the entry is not already there and if yes if it changed...
# Delete all entries from sql database
python manage.py flush

# Afterwards a new user needs to be added again
python manage.py createsuperuser

# Made some changes to the dashboard to make it more nicely to look at. Added some radio buttons before the ISP name. 
# Now i need to implement a class which holds the details about if an isp is activated with the device. I want to map that to the device id not mac or ip.
# If device moves the map should stay and i need to make sure to update rules so if communication with device A00000001 with IP 192.168.5.161 and MAC 11:11:11:11.. was allowed
# It should stay if device A00000001 with IP 192.168.5.164 and MAC 22:22:22:22..

################################
## 26.03.2025
################################
# Updating the models with a new one to assign isp names to device ids.
# First i implemented now a self register site where the device can go on add the device name, mac and ip. The ip is directly added but the mac isn't as easy so actually copying this data just from the settings into the form
# Problem now is does the macs / ips which where before in the form not automaticly get an end date. That needs to be fixed. First i wanted to remove also duplicate entries for mac and ip but it maces sense to keep that to have a nice history possibility 

# Found an API /api/diagnostics/interface/get_arp to get the active MAC / IP pairs with expiring time. This is the ARP table which keeps details for a specific time.
# Also changed the lease time so a device gets more likely again the same ip. Actually i give a range from 0.0.0.10 - 0.0.0.245 so 235 IP's together. I set the new lease time to 1209600 what means a leastime of 14 days. Getting down the ip changes for the same mac.
# Even if investigation time is longer. 

################################
## 28.03.2025
################################
# Still working on getting the matching between evidence_id and mac / ip... not yet happy.

################################
## 04.04.2025
################################
# Made design changes
# Added possibility to have rules linked to the device and show it in the frontend
# Run server not just local also in the network
python manage.py runserver 0.0.0.0:8000

################################
## 08.04.2025
################################
# In the past days i did some design changes. All rules are first stored in the db of django and afterwards added to the firewall. They are linked with the isp choice in the frontend.
# So if there is a isp marked as X in the checkbox it will add the relevant ip addresses from the isp to the db and afterwards push the rules to the firewall.
# Now i need to implement a rule which does the same but when unchecking. So go to the db look if rules are on the firewall and take them out. I don't want to delete the entry in the db to keep track...

# That seems to work now... but i have the problem if allowing a CDN does the rules can be more than 100 to add or remove... so the API is not done for adding just 100 rules and deleting them again. Need to see if there is a better approach.

################################
## 09.04.2025
################################
# Invested today pretty much the whole day in getting the DNS rule applied to the correct device and remove old rules based on the lease... that was quite a pain...
# signals.py fired several times when storing data sometimes got twice the same rule even rules for devices i did not even touch. However it seems to work now... Quite slow but it works.
# Always the newest lease which is applied to a device will be used and the DNS server which was set when adding the device will be added.

################################
## 10.04.2025
################################
# Discussed in the office the specific needs and usecases as the setting now can be used on most usescases now. It is important to have the opportunity to add specific rules to the firewall and to have an overview about added rules for each device what pretty much is just a database view
# Things to make research is to find out if there is a possibility to block the wipe and sound notification of an iOS device. I think that is not possible. Especially if we want to access the icloud data photos and stuff, we need to give access to the icloud network which is also combined to the find my network.
# Actually we do have a case were the phone is full and relevant movies are in the cloud. That because the preview is showing relevant movies which are not stored on the device. Now we should open the device to the icloud but we need to make sure it wont be wiped. As the suspect is no longer in "untersuchungshaft" it is likely he did access his account and added a remote wipe to his old devices.

################################
## 11.04.2025
################################
# Removed the idea of signals.py as i could not manage to get it working as expected. I will just add the rules to the firewall and remove them if needed. Directly in the view if/else with check if rule exists or not.
# I did change quite much of the code and added a completly new view i used earlier as python script in the opnsense project. It works fine but now i have the problem when running both views does i miss entries...
# I need to parse the logfiles centralized and access with the views just the db to get the app more responsive and to have a constitent data set...

# I made some try and error tests trying to get apple cloud / videos without getting the ring from find my network. I figured out the content of icloud is directly delivered by apple no CDN. That makes sense as these content is rarly accessed and just from a really small user group. So i would also implement it to deliver it by my self.
# The ring from the find my network was never triggered when opening all ips just without isp Apple. So i expect this is also just getting from apple directly and not over any other services. I tried to access just the ips with dns entries xx_aaplimg.com i was not able to access icloud photos or videos.
# So right at the moment i expect i won't have the opportunity to get access to the icloud data without exposing the device to the find my network.

################################
## 13.04.2025
################################
# The views do not longer parse the logfiles one view. So always accessing the db and not the logfiles. The logfiles are parsed when the webserver runs all 5 seconds.
# it is defined in apps.py
# Working on the firewall rule view. Want here to offer a delete function to remove the rules from the firewall. I'm not quite sure how it will react with the grouped view but we will see. I think it should work fine but i defintely need to test behavior.

#TODO: Use same table design as grouped view... to keep it consistent
#DONE: I want in the logfile view and grouped view the option to just add one specific IP, this will definitely impact the behavior of the grouped isps...

################################
## 16.04.2025
################################
# Now working for over 6 hours. I found out does some metadata enrichment was done and just after it was marked as old / with end date. I tried to figure out the problem but it is quite tricky...
# It seems i'm checking for data when just at the same moment the same data is stored... "Race conditions..."

# Seems worked today the whole day without adding any new feature. Now the Destination metadata seems to work as expected. Handling now some parts directly from the db.
# The only part which does ip enrichment is now the parser himself. No view or anything else. It seems to work as expected.

################################
## 17.04.2025
################################
# Finaly it works now smooth. Logs get parsed. The views get the data from the db.
# On the grouped view it is possible now to add remove rules these are marked now as manual rules. Added this to the model.
# The ISP Rule sets are just removing the rules which are not manual.

# Working with the OPNSense API is getting bad as adding more than 100 rules is a pain as this can take up minutes. I'm looking for a possibility to work with batch steps.
# Have not found any useful entry in the opnsense forum. Added now sessions to avoid the starting connection overhead. It is now between 0.1 - 0.5 seconds what feels now much quicker. It seems no batch processes possible.

# Made changes to the design so it looks better and more consistent.

########## I think this is quite a good state for the project at the moment. I will do some tests after easter and check in the team if anything is really needed.

################################
## 18.04.2025
################################
# Some code adjustments.

################################
## 20.04.2025
################################
# Added all logs to the database also passed ones. That is important to have a complete log capture. Especially for the report.
# Added a new field to keep dns ips safe and avoid to get removed by the cleanup process, when the isp '' is removed.

################################
## 24.04.2025
################################
# Discussed with our technical chief about the project and how he looks on data integrety. As the chief wanted to have everything not changeable in a forensic matter. So there should no logs be deleted or changed.
# The technical chief told me does that is always a good approach but it should not take now the next months to just get that done.
# Otherwise the logs would need to be written right away on another safe place with hashing all the time. WORM or anything into this direction. For a tool which is just used a few times a year that would be a complete overkill.
# Even today there are no logs at all. Our approach needs to be a root user which has access to the system. All other users do just have restricted access. Read only in many cases. The frontend and also the database access on the django side should be read only for the regular forensic user.
# There should never be a case where a log needs to be deleted or changed. So getting regular logs to an archive with hashing would be a first approach.

################################
## 25.04.2025
################################
# Design adjustments. 

################################
## 28.04.2025
################################

### Meeting with Peter Heinrich
# State of the project is good. Next steps Bugfixing.
# #TODO For DNS just allow port 53 instead of all ports.
# #TODO MAC Address with 42 52 are random devices because of the second two. 
# #TODO MX Record for lookup page needed?
# #TODO UDP -> QUIC traffic L4 (Youtube) logging on firewall base?

# #TODO valdiation: 
# Define scenarios which will be needed in our case. These scenarios will be used to test the system. Will it work, will it fail? When will it fail? If it fail can it be fixed to work or is that a usecase we cannot solve?
# Own ideas:
# For all use cases we need to make sure the device is not wiped. No other apps get connections and messages are sent or received (Other not tested app!).
# 1. Get access to the Apple Cloud, accessing pictures and videos from the icloud
# 2. Get access to the telgram app, get old attachments and messages which are not stored on the device
# ...
# 
# Let the system be tried out by a peer. Is the system working as expected? Is the UI good enough? Is the system easy to use?
# 
###

# Changed MetadataSeenByDevice from view to the log parser. So it is always up to date. Field of first seen will now be time the parser checks logfile and sees a ip first time. If a ip is seen again it will update last_seen field. So there is the information about when a entry was added and when a entry was last seen.
# Added sorting to all tables in the dashboard. I implemented it locally as I don't want to give in the future access to sources if not needed. Thanks to "Stuart Langridge" which gives the full use right of his sorttable.js (static/js/sorttable.js)

{
    "query": "52.97.201.242",
    "status": "success",
    "continent": "Europe",
    "continentCode": "EU",
    "country": "Switzerland",
    "countryCode": "CH",
    "region": "ZH",
    "regionName": "Zurich",
    "city": "Zurich",
    "district": "",
    "zip": "",
    "lat": 47.3768,
    "lon": 8.5416,
    "timezone": "Europe/Zurich",
    "offset": 7200,
    "currency": "CHF",
    "isp": "Microsoft Corporation",
    "org": "Microsoft Corporation",
    "as": "AS8075 Microsoft Corporation",
    "asname": "MICROSOFT-CORP-MSN-AS-BLOCK",
    "mobile": false,
    "proxy": false,
    "hosting": true
}
